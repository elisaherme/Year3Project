// First we include the libraries
#include <OneWire.h> 
#include <DallasTemperature.h>

// Data wire is plugged into pin 2 on the Arduino 
#define ONE_WIRE_BUS 2 

// Setup a oneWire instance to communicate with any OneWire devices  
// (not just Maxim/Dallas temperature ICs) 
OneWire oneWire(ONE_WIRE_BUS); 
// Pass our oneWire reference to Dallas Temperature. 
DallasTemperature sensors(&oneWire);

int ethanol_sensor = A0;
int threshold = 40; //sweat prodcing threshold temperature
float loadResistance = 2200; //Put in value of pull down resistance
float controlResistance = 1.5; //Put in value of standar resistance of the sensor at 300ppm, refer to the datasheet
// http://www.figarosensor.com/products/2620pdf.pdf
int timeInSeconds = 0;

float ethanolVoltage = 0.0;
float sensorResistance = 0.0;
float ethanolConcentration = 0.0;

float ethanolReading = 0.0;
float tempReading = 0.0;

float tempValue = 0.0;
float ethanolValue = 0.0; //measured in ppm

unsigned long minutes = 60000;

double EthanolConcWithTime[];

void setup() {
  Serial.begin(9600); //put your setup code here, to run once:
  sensors.begin();
  Serial.println("Time:\t\tEthanol Value: \t\tTempValue: ");
  Serial.println("-----\t\t--------------\t\t----------");
}

void loop() {
  if (millis() <= minutes * 5) {
    Serial.print(timeInSeconds);
    Serial.print("\t\t");
    //analogRead returns value 0-1023 where the input voltage is 0-5V
    ethanolReading = analogRead(ethanol_sensor);
    //analog voltage reading ranges from about 0 to 1023 which maps to 0V to 5V (= 5000mV)
    ethanolVoltage = map(ethanolReading, 0, 1023, 0, 5000); //Change values depending on the sensor
    //Process value from the sensor into actual ethanol value 
    //5V (Voltage divider)
    //sensorResistance = ((5-ethanolVoltage)/ethanolVoltage)*loadResistance;
    //ethanolConcentration = (sensorResistance/controlResistance)*300;
    //ethanolValue = ethanolConcentration*100; //From ppm to BAC
    // need to calibrate the ethanol value to get the control resistance
    //Save value - send through Bluetooth
    Serial.print(ethanolVoltage);
    Serial.print("\t\t");
    EthanolConcWithTime[timeInSeconds] = ethanolValue;
  
    sensors.requestTemperatures(); // Send the command to get temperature readings
    //Put temperate sensor into digital pin 2
    tempValue = sensors.getTempCByIndex(0);// Why "byIndex"?  
     // You can have more than one DS18B20 on the same bus.  
     // 0 refers to the first IC on the wire 
    
    //Serial.println("Temp Value: "); // Print temp to screen for testing but not for final product
    Serial.println(tempValue);
    
    timeInSeconds++;
    delay(1000); //It's in milliseconds
    
  }
  } else { //5 minutes is up
    delay(1000); //It's in milliseconds
    //turn stuff off
  }
}

// http://www.figarosensor.com/products/2620pdf.pdf
